<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workers - Distributed Task Processing System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            padding-top: 56px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .sidebar {
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #f8f9fa;
            width: 240px; /* Fixed width */
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .main-content {
            margin-left: 240px; /* This should match the sidebar width */
            padding: 20px;
            flex: 1;
        }
        @media (max-width: 767.98px) {
            .sidebar {
                top: 5rem;
            }
            .main-content {
                margin-left: 0;
            }
        }
        .nav-link {
            font-weight: 500;
            color: #333;
        }
        .nav-link.active {
            color: #007bff;
        }
        .flash-messages {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .worker-card {
            transition: transform 0.2s;
        }
        .worker-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.6rem;
        }
        .worker-detail-container {
            display: none;
        }
        .worker-list-container {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Task Processing System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tasks.html">Tasks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="workers.html">Workers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="plugins.html">Plugins</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="tasks.html">
                                <i class="fas fa-tasks me-2"></i>
                                All Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="tasks.html?status=pending">
                                <i class="fas fa-clock me-2"></i>
                                Pending Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="tasks.html?status=in_process">
                                <i class="fas fa-spinner me-2"></i>
                                In-Process Tasks
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link active" href="workers.html">
                                <i class="fas fa-server me-2"></i>
                                All Workers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="workers.html?status=active">
                                <i class="fas fa-play-circle me-2"></i>
                                Active Workers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="workers.html?status=idle">
                                <i class="fas fa-pause-circle me-2"></i>
                                Idle Workers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="workers.html?status=offline">
                                <i class="fas fa-stop-circle me-2"></i>
                                Offline Workers
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link" href="plugins.html">
                                <i class="fas fa-puzzle-piece me-2"></i>
                                Plugins
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="register-plugin.html">
                                <i class="fas fa-plus-circle me-2"></i>
                                Register Plugin
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link" href="plugins.html">
                                <i class="fas fa-plus me-2"></i>
                                Submit New Task
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Flash messages -->
                <div class="flash-messages" id="flash-messages">
                    <!-- Flash messages will be dynamically added here -->
                </div>

                <!-- Worker List Container -->
                <div id="worker-list-container" class="worker-list-container">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 id="worker-list-title">All Workers</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter controls -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="Search workers...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="status-filter">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="idle">Idle</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                    </div>

                    <!-- Workers table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="workers-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Hostname</th>
                                            <th>IP</th>
                                            <th>Status</th>
                                            <th>Active Tasks</th>
                                            <th>Plugins</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="workers-table-body">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2">Loading workers...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Worker Detail Container -->
                <div id="worker-detail-container" class="worker-detail-container">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" id="back-to-workers">Workers</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Worker Details</li>
                        </ol>
                    </nav>

                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1>Worker Details</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-detail-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="back-btn">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="worker-detail-content">
                        <!-- Worker details will be dynamically added here -->
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading worker details...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Config -->
    <script src="config.js"></script>
 
    
    <script>

        // Global state
        let currentStatus = '';
        let currentSearch = '';
        let currentWorkerId = '';
        
        // Helper functions
        function showFlashMessage(message, category = 'info') {
            const flashContainer = document.getElementById('flash-messages');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${category} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            flashContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.classList.remove('show');
                    setTimeout(() => alertElement.remove(), 150);
                }
            }, 5000);
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'success';
                case 'idle': return 'warning';
                case 'offline': return 'secondary';
                default: return 'info';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }
        
        function truncateId(id) {
            if (id && id.length > 8) {
                return id.substring(0, 8) + '...';
            }
            return id || 'N/A';
        }
        
        // API functions
        async function fetchAPI(endpoint, options = {}) {
            try {
                // Ensure credentials are included
                options.credentials = 'include';
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API request failed with status ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                showFlashMessage(error.message, 'danger');
                throw error;
            }
        }
        
        // Worker list functions
        async function loadWorkers() {
            try {
                document.getElementById('workers-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading workers...</p>
                        </td>
                    </tr>
                `;
                
                let endpoint = '/workers';
                
                if (currentStatus) {
                    endpoint += `?status=${currentStatus}`;
                }
                
                const workers = await fetchAPI(endpoint);
                
                // Update worker list title
                let titleText = currentStatus ? 
                    `${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)} Workers` : 
                    'All Workers';
                document.getElementById('worker-list-title').textContent = titleText;
                
                // Update table
                if (workers.length === 0) {
                    document.getElementById('workers-table-body').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">No workers found</td>
                        </tr>
                    `;
                } else {
                    const tableHtml = workers.map(worker => `
                        <tr class="worker-row" data-worker-id="${worker.id}">
                            <td title="${worker.id}">${truncateId(worker.id)}</td>
                            <td>${worker.hostname}</td>
                            <td>${worker.ip}</td>
                            <td>
                                <span class="badge bg-${getStatusBadgeClass(worker.status)} status-badge">${worker.status}</span>
                            </td>
                            <td>${worker.active_tasks ? worker.active_tasks.length : 0}</td>
                            <td>${worker.plugins ? Object.keys(worker.plugins).length : 0}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-worker-btn" data-worker-id="${worker.id}">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('workers-table-body').innerHTML = tableHtml;
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-worker-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const workerId = e.currentTarget.getAttribute('data-worker-id');
                            viewWorkerDetails(workerId);
                        });
                    });
                    
                    // Add event listeners to worker rows
                    document.querySelectorAll('.worker-row').forEach(row => {
                        row.addEventListener('click', (e) => {
                            if (!e.target.closest('.btn')) {
                                const workerId = row.getAttribute('data-worker-id');
                                viewWorkerDetails(workerId);
                            }
                        });
                    });
                }
                
            } catch (error) {
                console.error('Error loading workers:', error);
                document.getElementById('workers-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading workers: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Worker detail functions
        async function viewWorkerDetails(workerId) {
            currentWorkerId = workerId;
            
            // Show worker detail container and hide worker list container
            document.getElementById('worker-list-container').style.display = 'none';
            document.getElementById('worker-detail-container').style.display = 'block';
            
            await loadWorkerDetails();
        }
        
        async function loadWorkerDetails() {
            try {
                document.getElementById('worker-detail-content').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading worker details...</p>
                    </div>
                `;
                
                const worker = await fetchAPI(`/workers/${currentWorkerId}`);
                
                // Get worker metrics
                let metricsHtml = '';
                try {
                    const metrics = await fetchAPI(`/metrics/worker/${currentWorkerId}`);
                    if (metrics && metrics.length > 0) {
                        // Create metrics chart
                        metricsHtml = `
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Worker Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <canvas id="cpuChart"></canvas>
                                        </div>
                                        <div class="col-md-6">
                                            <canvas id="ramChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <h6>Recent Metrics</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Timestamp</th>
                                                            <th>CPU Usage</th>
                                                            <th>RAM Usage</th>
                                                            <th>Active Tasks</th>
                                                            <th>Tasks Processed</th>
                                                            <th>Success Rate</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${metrics.slice(0, 5).map(metric => `
                                                            <tr>
                                                                <td>${formatDate(metric.timestamp)}</td>
                                                                <td>${metric.cpu_usage_percent.toFixed(1)}%</td>
                                                                <td>${metric.ram_usage_percent.toFixed(1)}%</td>
                                                                <td>${metric.active_task_count}</td>
                                                                <td>${metric.tasks_processed}</td>
                                                                <td>${metric.tasks_processed > 0 ? 
                                                                    ((metric.tasks_succeeded / metric.tasks_processed) * 100).toFixed(1) + '%' : 
                                                                    'N/A'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading worker metrics:', error);
                }
                
                // Get active tasks
                let tasksHtml = '';
                if (worker.active_tasks && worker.active_tasks.length > 0) {
                    const taskPromises = worker.active_tasks.map(taskId => fetchAPI(`/tasks/${taskId}`));
                    try {
                        const tasks = await Promise.all(taskPromises);
                        
                        tasksHtml = `
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Active Tasks</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Type</th>
                                                    <th>Status</th>
                                                    <th>Started At</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tasks.map(task => `
                                                    <tr>
                                                        <td title="${task.id}">${truncateId(task.id)}</td>
                                                        <td>${task.type}</td>
                                                        <td>
                                                            <span class="badge bg-${getTaskStatusBadgeClass(task.status)}">${task.status}</span>
                                                        </td>
                                                        <td>${formatDate(task.started_at)}</td>
                                                        <td>
                                                            <a href="tasks.html?id=${task.id}" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-info-circle"></i> View
                                                            </a>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error loading worker tasks:', error);
                        tasksHtml = `
                            <div class="alert alert-warning mt-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Could not load active tasks: ${error.message}
                            </div>
                        `;
                    }
                }
                
                const detailHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Worker Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6 class="text-muted">ID</h6>
                                        <p>${worker.id}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Hostname</h6>
                                        <p>${worker.hostname}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">IP Address</h6>
                                        <p>${worker.ip}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Status</h6>
                                        <p><span class="badge bg-${getStatusBadgeClass(worker.status)} status-badge">${worker.status}</span></p>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6 class="text-muted">Registered At</h6>
                                        <p>${formatDate(worker.registered_at)}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Active Tasks</h6>
                                        <p>${worker.active_tasks ? worker.active_tasks.length : 0}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="text-muted">Queues</h6>
                                        <p>${worker.queues && worker.queues.length > 0 ? 
                                            worker.queues.map(q => `<span class="badge bg-info me-1">${q}</span>`).join(' ') : 
                                            'None'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted">Resources</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h5>CPU Usage</h5>
                                                <div class="display-4">${worker.resources.cpu_usage.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h5>RAM Total</h5>
                                                <div class="display-4">${worker.resources.ram_total.toFixed(1)} GB</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h5>RAM Available</h5>
                                                <div class="display-4">${worker.resources.ram_available.toFixed(1)} GB</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted">Plugins</h6>
                                ${worker.plugins && Object.keys(worker.plugins).length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Plugin ID</th>
                                                    <th>Version</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(worker.plugins).map(([id, version]) => `
                                                    <tr>
                                                        <td>${id}</td>
                                                        <td>${version}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p>No plugins installed</p>'}
                            </div>
                        </div>
                    </div>
                    
                    ${tasksHtml}
                    ${metricsHtml}
                `;
                
                document.getElementById('worker-detail-content').innerHTML = detailHtml;
                
                // Initialize charts if metrics are available
                if (metricsHtml) {
                    initCharts();
                }
                
            } catch (error) {
                console.error('Error loading worker details:', error);
                document.getElementById('worker-detail-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading worker details: ${error.message}
                    </div>
                `;
            }
        }
        
        function getTaskStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'primary';
                case 'in_process': return 'warning';
                case 'completed': return 'success';
                case 'failed': return 'danger';
                case 'manual_review': return 'secondary';
                default: return 'info';
            }
        }

        function initCharts() {
            // CPU usage chart
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: ['5 min ago', '4 min ago', '3 min ago', '2 min ago', '1 min ago', 'Now'],
                    datasets: [{
                        label: 'CPU Usage %',
                        data: [25, 30, 45, 60, 75, 65],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // RAM usage chart
            const ramCtx = document.getElementById('ramChart').getContext('2d');
            new Chart(ramCtx, {
                type: 'line',
                data: {
                    labels: ['5 min ago', '4 min ago', '3 min ago', '2 min ago', '1 min ago', 'Now'],
                    datasets: [{
                        label: 'RAM Usage %',
                        data: [40, 42, 45, 50, 55, 60],
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function backToWorkerList() {
            document.getElementById('worker-detail-container').style.display = 'none';
            document.getElementById('worker-list-container').style.display = 'block';
            currentWorkerId = '';
        }
        
        // Initialize
        window.onload = async () => {

            console.log("Window loaded, initializing workers page...");
            
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentStatus = urlParams.get('status') || '';
            
            // Update status filter
            if (currentStatus) {
                document.getElementById('status-filter').value = currentStatus;
            }
            
            // Load workers
            loadWorkers();
            
            // Add event listeners
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadWorkers();
            });
            
            document.getElementById('back-btn').addEventListener('click', () => {
                backToWorkerList();
            });
            
            document.getElementById('back-to-workers').addEventListener('click', (e) => {
                e.preventDefault();
                backToWorkerList();
            });
            
            document.getElementById('refresh-detail-btn').addEventListener('click', () => {
                if (currentWorkerId) {
                    loadWorkerDetails();
                }
            });
            
            document.getElementById('status-filter').addEventListener('change', (e) => {
                currentStatus = e.target.value;
                loadWorkers();
                
                // Update URL
                const url = new URL(window.location);
                if (currentStatus) {
                    url.searchParams.set('status', currentStatus);
                } else {
                    url.searchParams.delete('status');
                }
                window.history.pushState({}, '', url);
            });
            
            document.getElementById('search-btn').addEventListener('click', () => {
                currentSearch = document.getElementById('search-input').value;
                loadWorkers();
            });
            
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = e.target.value;
                    loadWorkers();
                }
            });
        };
    </script>
